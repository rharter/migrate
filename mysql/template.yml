# Templates for SQL generation

# Header comment to be inserted at the top of 
# each generated script
header: "/**\n
 * Mobile Marshall Schema script\n
 * \n
 * Autogenerated by migrate on #{date}\n
 *\n
 * Copyright 2012 Serious Apps.\n
 */\n"

# SQL used to generate the Schema tracking table
schema_table: "DROP TABLE IF EXISTS `MM_Schema_Change`;\n
 CREATE TABLE `MM_Schema_Change` (\n
   `schema_change_id` bigint(20) NOT NULL,\n
   `schema_change_description` varchar(254) NOT NULL,\n
   `schema_change_timechanged` timestamp NOT NULL,\n
   PRIMARY KEY (`schema_change_id`)\n
 ) ENGINE=InnoDB DEFAULT CHARSET=latin1;\n"

# SQL used to update the sql tracking table
schema_table_insert: "INSERT INTO MM_Schema_Change (schema_change_description, schema_change_timechanged) 
VALUES ('#{name}', NOW());\n"

# The actual migration
migration: "DROP PROCEDURE IF EXISTS Migration_#{name};\n
\n
DELIMITER //\n
\n
CREATE PROCEDURE Migration_#{name}()\n
\n
	BEGIN\n
\n
		IF 0 = (SELECT COUNT(1)\n
			FROM MM_Schema_Change\n
			WHERE schema_change_description = '#{name}')\n
		THEN\n
		\n
			#{content};\n
			\n
			#{schema_table_insert}\n
			\n
		END IF;\n
	END //\n
\n
DELIMITER ;\n
\n
CALL Migration_#{name}();\n
\n
DROP PROCEDURE Migration_#{name};\n"